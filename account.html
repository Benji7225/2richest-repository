<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Profil - The Richest</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .profile-container {
      background-color: var(--surface-color);
      border-radius: var(--card-radius);
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .profile-avatar-container {
      position: relative;
      margin-bottom: 16px;
    }
    
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-color);
    }
    
    .avatar-edit {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: var(--primary-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .avatar-edit svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .avatar-edit input[type="file"] {
      display: none;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--input-radius);
      border: 1px solid var(--border-color);
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--text-color);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
    }
    
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .actions {
      display: flex;
      justify-content: space-between;
      gap: 16px;
    }
    
    .actions button {
      flex: 1;
    }
    
    .avatar-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    
    .gallery-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .gallery-item.selected {
      border-color: var(--primary-color);
      transform: scale(1.05);
    }
    
    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-modal {
      max-width: 500px;
    }
    
    .tab-container {
      margin-bottom: 16px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 16px;
    }
    
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .url-input {
      margin-bottom: 16px;
    }
    
    .preview-container {
      display: flex;
      justify-content: center;
      margin: 16px 0;
    }
    
    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary-color);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg class="flame-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C10.9 2 9.9 2.2 8.9 2.6C9.5 3.3 9.9 4.2 9.9 5.1C9.9 7.5 7.9 9.5 5.5 9.5C4.6 9.5 3.7 9.2 3 8.6C2.6 9.6 2.4 10.7 2.4 11.7C2.4 16.8 6.7 21 11.8 21C16.9 21 21.2 16.7 21.2 11.6C21.3 6.2 17.1 2 12 2ZM10.4 16.8C9.1 16.8 8 15.7 8 14.4C8 13.3 8.7 12.4 9.7 12.1C11.5 11.6 13 10.1 13.5 8.3C13.8 9.3 14.7 10 15.8 10C17.1 10 18.2 11.1 18.2 12.4C18.2 15 14.6 16.8 10.4 16.8Z" fill="#FF9500"/>
      </svg>
      <h1>The Richest</h1>
    </div>
    <a href="index.html" class="btn btn-secondary">Retour</a>
  </header>

  <main>
    <div class="profile-container">
      <div class="profile-header">
        <div class="profile-avatar-container">
          <img id="profile-avatar-large" class="profile-avatar" src="https://images.pexels.com/photos/1681010/pexels-photo-1681010.jpeg?auto=compress&cs=tinysrgb&w=150" alt="Avatar">
          <label for="avatar-upload" class="avatar-edit">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M21.7 7.3l-5-5c-.4-.4-1-.4-1.4 0l-13 13c-.2.2-.3.4-.3.7v5c0 .6.4 1 1 1h5c.3 0 .5-.1.7-.3l13-13c.4-.4.4-1 0-1.4zM7.6 20H4v-3.6l12-12L19.6 8l-12 12z"/>
            </svg>
            <input type="file" id="avatar-upload" accept="image/*">
          </label>
        </div>
        <h2 id="profile-name">Mon Profil</h2>
      </div>
      
      <form id="profile-form">
        <div class="form-group">
          <label for="pseudo">Pseudo</label>
          <input type="text" id="pseudo" name="pseudo" placeholder="Votre pseudo" required>
        </div>
        
        <div class="form-group">
          <label for="phrase">Phrase personnelle</label>
          <textarea id="phrase" name="phrase" placeholder="Votre phrase personnelle (optionnel)"></textarea>
        </div>
        
        <div class="actions">
          <button type="button" id="reset-button" class="btn btn-secondary">Réinitialiser</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
    
    <div class="profile-container">
      <h3>Données</h3>
      <p style="margin-bottom: 16px;">Exportez vos données pour les sauvegarder ou les transférer.</p>
      
      <div class="actions">
        <button id="export-button" class="btn btn-secondary">Exporter JSON</button>
        <button id="import-button" class="btn btn-secondary">Importer JSON</button>
      </div>
    </div>
  </main>
  
  <!-- Modal de sélection d'avatar -->
  <div id="avatar-modal" class="modal">
    <div class="modal-content avatar-modal">
      <h2>Choisir un avatar</h2>
      
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="gallery">Galerie</div>
          <div class="tab" data-tab="url">URL</div>
        </div>
        
        <div class="tab-content active" data-tab="gallery">
          <div class="avatar-gallery" id="avatar-gallery">
            <!-- Les avatars seront ajoutés dynamiquement -->
          </div>
        </div>
        
        <div class="tab-content" data-tab="url">
          <div class="form-group url-input">
            <label for="avatar-url">URL de l'image</label>
            <input type="url" id="avatar-url" placeholder="https://example.com/image.jpg">
          </div>
          
          <div class="preview-container">
            <img id="avatar-url-preview" class="avatar-preview" src="https://images.pexels.com/photos/1681010/pexels-photo-1681010.jpeg?auto=compress&cs=tinysrgb&w=150" alt="Aperçu">
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button id="cancel-avatar" class="btn btn-secondary">Annuler</button>
        <button id="confirm-avatar" class="btn btn-primary">Confirmer</button>
      </div>
    </div>
  </div>
  
  <!-- Modal d'import -->
  <div id="import-modal" class="modal">
    <div class="modal-content">
      <h2>Importer des données</h2>
      
      <div class="form-group">
        <label for="import-data">Collez vos données JSON</label>
        <textarea id="import-data" rows="10" placeholder='{"users":{...}}' style="font-family: monospace;"></textarea>
      </div>
      
      <div class="modal-actions">
        <button id="cancel-import" class="btn btn-secondary">Annuler</button>
        <button id="confirm-import" class="btn btn-primary">Importer</button>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast">
    <span id="toast-message"></span>
  </div>
  
  <script type="module">
    import { getStorageKey } from './app.js';
    


    
    // Fonction pour afficher un toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toast.className = 'toast show';
      if (type === 'error') {
        toast.style.backgroundColor = '#ef4444';
      } else {
        toast.style.backgroundColor = '#10B981';
      }
      
      toastMessage.textContent = message;
      
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }
    
    // Charger les données de l'utilisateur
    function loadUserData() {
      try {
        const userData = JSON.parse(localStorage.getItem('richest:v1:currentUser') || '{}');
        
        // Remplir le formulaire
        document.getElementById('pseudo').value = userData.pseudo || 'Moi';
        document.getElementById('phrase').value = userData.phrase || '';
        document.getElementById('profile-name').textContent = userData.pseudo || 'Mon Profil';
        
        // Mettre à jour l'avatar
        const avatarLarge = document.getElementById('profile-avatar-large');
        avatarLarge.src = userData.avatar || galleryAvatars[0];
      } catch (error) {
        console.error('Erreur lors du chargement des données utilisateur:', error);
      }
    }
    
    // Sauvegarder les données de l'utilisateur
    function saveUserData(event) {
      event.preventDefault();
      
      try {
        const pseudo = document.getElementById('pseudo').value.trim();
        const phrase = document.getElementById('phrase').value.trim();
        const avatar = document.getElementById('profile-avatar-large').src;
        
        if (!pseudo) {
          showToast('Le pseudo est requis', 'error');
          return;
        }
        
        // Récupérer les données existantes
        const existingData = JSON.parse(localStorage.getItem('richest:v1:currentUser') || '{}');
        
        // Mettre à jour les données
        const userData = {
          ...existingData,
          id: 'me',
          pseudo,
          phrase,
          avatar
        };
        
        // Sauvegarder
        localStorage.setItem('richest:v1:currentUser', JSON.stringify(userData));
        
        // Mettre à jour le nom affiché
        document.getElementById('profile-name').textContent = pseudo;
        
        // Mettre à jour les données dans le classement
        updateLeaderboardUser();
        
        showToast('Profil mis à jour avec succès');
      } catch (error) {
        console.error('Erreur lors de la sauvegarde des données:', error);
        showToast('Erreur lors de la sauvegarde des données', 'error');
      }
    }
    
    // Mettre à jour l'utilisateur dans le classement
    function updateLeaderboardUser() {
      try {
        const storageKey = getStorageKey();
        const leaderboardData = JSON.parse(localStorage.getItem(storageKey) || '{}');
        
        if (leaderboardData.users && leaderboardData.users.me) {
          const userData = JSON.parse(localStorage.getItem('richest:v1:currentUser') || '{}');
          
          leaderboardData.users.me.pseudo = userData.pseudo || 'Moi';
          leaderboardData.users.me.avatar = userData.avatar || galleryAvatars[0];
          leaderboardData.users.me.phrase = userData.phrase || '';
          
          localStorage.setItem(storageKey, JSON.stringify(leaderboardData));
        }
      } catch (error) {
        console.error('Erreur lors de la mise à jour du classement:', error);
      }
    }
    
    // Réinitialiser le profil
    function resetProfile() {
      if (confirm('Êtes-vous sûr de vouloir réinitialiser votre profil ?')) {
        localStorage.removeItem('richest:v1:currentUser');
        loadUserData();
        showToast('Profil réinitialisé');
      }
    }
    
    // Gérer l'upload d'avatar
    function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Vérifier que c'est une image
      if (!file.type.startsWith('image/')) {
        showToast('Veuillez sélectionner une image', 'error');
        return;
      }

      // Lire le fichier
      const reader = new FileReader();
      reader.onload = function(e) {
        const avatarUrl = e.target.result;
        document.getElementById('profile-avatar-large').src = avatarUrl;
        showToast('Avatar mis à jour');
      };
      reader.readAsDataURL(file);
    }
    
    // Fermer le modal d'avatar
    function closeAvatarModal() {
      const modal = document.getElementById('avatar-modal');
      modal.style.display = 'none';
    }
    
    // Confirmer la sélection d'avatar
    function confirmAvatar() {
      const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
      let avatarUrl;
      
      if (activeTab === 'gallery') {
        const selectedItem = document.querySelector('.gallery-item.selected');
        if (selectedItem) {
          avatarUrl = selectedItem.querySelector('img').src;
        } else {
          showToast('Veuillez sélectionner un avatar', 'error');
          return;
        }
      } else {
        avatarUrl = document.getElementById('avatar-url').value.trim();
        if (!avatarUrl) {
          showToast('Veuillez entrer une URL valide', 'error');
          return;
        }
      }
      
      // Mettre à jour l'avatar
      document.getElementById('profile-avatar-large').src = avatarUrl;
      
      closeAvatarModal();
    }
    
    // Changer d'onglet
    function changeTab(event) {
      const tabName = event.target.getAttribute('data-tab');
      
      // Désactiver tous les onglets
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Désactiver tous les contenus
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Activer l'onglet cliqué
      event.target.classList.add('active');
      
      // Activer le contenu correspondant
      document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
    }
    
    // Prévisualiser l'URL
    function previewAvatarUrl() {
      const url = document.getElementById('avatar-url').value.trim();
      const preview = document.getElementById('avatar-url-preview');
      
      if (url) {
        preview.src = url;
      } else {
        preview.src = galleryAvatars[0];
      }
    }
    
    // Exporter les données
    function exportData() {
      try {
        const storageKey = getStorageKey();
        const data = localStorage.getItem(storageKey);
        
        if (!data) {
          showToast('Aucune donnée à exporter', 'error');
          return;
        }
        
        // Créer un élément de lien pour le téléchargement
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(data));
        element.setAttribute('download', `the-richest-${storageKey.split(':').pop()}.json`);
        
        element.style.display = 'none';
        document.body.appendChild(element);
        
        element.click();
        
        document.body.removeChild(element);
        showToast('Données exportées avec succès');
      } catch (error) {
        console.error('Erreur lors de l\'export:', error);
        showToast('Erreur lors de l\'export des données', 'error');
      }
    }
    
    // Ouvrir le modal d'import
    function openImportModal() {
      const modal = document.getElementById('import-modal');
      modal.style.display = 'flex';
      document.getElementById('import-data').value = '';
    }
    
    // Fermer le modal d'import
    function closeImportModal() {
      const modal = document.getElementById('import-modal');
      modal.style.display = 'none';
    }
    
    // Importer les données
    function importData() {
      try {
        const jsonData = document.getElementById('import-data').value.trim();
        
        if (!jsonData) {
          showToast('Veuillez entrer des données JSON valides', 'error');
          return;
        }
        
        // Valider le JSON
        const data = JSON.parse(jsonData);
        
        if (!data.users) {
          showToast('Format de données invalide', 'error');
          return;
        }
        
        // Sauvegarder les données
        const storageKey = getStorageKey();
        localStorage.setItem(storageKey, jsonData);
        
        closeImportModal();
        showToast('Données importées avec succès');
      } catch (error) {
        console.error('Erreur lors de l\'import:', error);
        showToast('Erreur lors de l\'import des données: ' + error.message, 'error');
      }
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      // Charger les données utilisateur
      loadUserData();
      
      // Événements du formulaire
      document.getElementById('profile-form').addEventListener('submit', saveUserData);
      document.getElementById('reset-button').addEventListener('click', resetProfile);
      
      // Événement de l'avatar upload
      document.getElementById('avatar-upload').addEventListener('change', handleAvatarUpload);
      
      // Événements des onglets
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', changeTab);
      });
      
      // Événement de prévisualisation d'URL
      document.getElementById('avatar-url').addEventListener('input', previewAvatarUrl);
      
      // Événements d'export/import
      document.getElementById('export-button').addEventListener('click', exportData);
      document.getElementById('import-button').addEventListener('click', openImportModal);
      document.getElementById('cancel-import').addEventListener('click', closeImportModal);
      document.getElementById('confirm-import').addEventListener('click', importData);
    });
  </script>
</body>
</html>
